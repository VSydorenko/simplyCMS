
# Система відгуків та рейтингів товарів

## Огляд

Створення повноцінної системи відгуків з рейтингами для товарів: написання відгуків через TipTap редактор, завантаження зображень, модерація адміном, відображення середнього рейтингу.

---

## Фаза 1: База даних та Storage

### 1.1 Таблиця `product_reviews`

| Колонка | Тип | Призначення |
|---|---|---|
| `id` | `uuid PK` | Ідентифікатор |
| `product_id` | `uuid FK -> products` | Товар |
| `user_id` | `uuid FK -> auth.users` | Автор (NOT NULL) |
| `rating` | `integer` | Рейтинг 1-5 (NOT NULL) |
| `title` | `text` | Заголовок відгуку (опціонально) |
| `content` | `text` | HTML-контент з TipTap |
| `images` | `jsonb` | Масив URL зображень |
| `status` | `text` | `pending` / `approved` / `rejected` (default: `pending`) |
| `admin_comment` | `text` | Коментар адміна (причина відхилення) |
| `created_at` | `timestamptz` | Дата створення |
| `updated_at` | `timestamptz` | Дата оновлення |

Validation trigger: rating >= 1 AND rating <= 5.

Unique constraint: `(product_id, user_id)` - один відгук на товар від одного користувача.

### 1.2 RLS-політики

- **SELECT**: Всі можуть бачити відгуки зі статусом `approved`. Автор бачить свої відгуки з будь-яким статусом. Адміни бачать усі.
- **INSERT**: Тільки авторизовані користувачі, `user_id = auth.uid()`.
- **UPDATE**: Автор може оновити свій відгук зі статусом `pending`. Адміни можуть оновлювати будь-який (зміна статусу).
- **DELETE**: Автор може видалити свій. Адміни можуть видаляти будь-який.

### 1.3 Storage бакет `review-images`

- Публічний бакет для зображень відгуків.
- Структура папок: `{product_id}/{filename}`.
- RLS: завантаження тільки авторизованими, видалення - автором або адміном.
- Обмеження: тільки зображення (jpg, png, webp, gif), макс. 5MB.

---

## Фаза 2: Фронтенд-компоненти

### 2.1 Компонент `ProductReviews`

Секція на сторінці товару (додається як нова вкладка "Відгуки" в навігації ProductDetail). Включає:

- **Середній рейтинг** (зірки + число) та кількість відгуків.
- **Розподіл по рейтингах** (прогрес-бари: скільки 5-зірок, 4-зірок тощо).
- **Список відгуків** з пагінацією або "Завантажити ще".
- **Кнопка "Написати відгук"** (для авторизованих) або блок з поясненням та кнопкою "Увійти" (для гостей).

### 2.2 Компонент `ReviewCard`

Картка одного відгуку:
- Аватар та ім'я автора (з `profiles`).
- Рейтинг зірками.
- Дата.
- HTML-контент (рендер через `dangerouslySetInnerHTML` з санітизацією).
- Галерея зображень (клік - збільшення в лайтбоксі).
- Бейдж "На модерації" (видно тільки автору для його pending-відгуків).
- Кнопка "Видалити" (для автора свого відгуку).

### 2.3 Компонент `ReviewForm`

Форма для написання відгуку:
- **Рейтинг**: інтерактивні зірки (клік для вибору 1-5).
- **Заголовок**: текстове поле (опціонально).
- **Текст відгуку**: RichTextEditor (TipTap) - спрощена версія без заголовків та вирівнювання, тільки bold/italic/списки.
- **Зображення**: ImageUpload (bucket: `review-images`, folder: `{productId}`), макс. 5 зображень.
- Кнопка "Надіслати відгук".

### 2.4 Компонент `StarRating`

Переіспользовуваний компонент зірок:
- Режим "display" (тільки перегляд, підтримка половин зірок для середнього).
- Режим "input" (hover-ефект, клік для вибору).

### 2.5 Хук `useProductReviews(productId)`

- Завантаження відгуків товару.
- Підрахунок середнього рейтингу та розподілу.
- Перевірка, чи поточний користувач вже залишив відгук.

---

## Фаза 3: Адмін-панель

### 3.1 Сторінка `/admin/reviews` - Модерація відгуків

Список всіх відгуків з фільтрацією:
- Фільтри: статус (pending/approved/rejected), рейтинг.
- Табличне відображення: товар, автор, рейтинг, дата, статус.
- Клік по рядку - відкриття деталей.

### 3.2 Сторінка `/admin/reviews/:reviewId` - Деталі відгуку

- Повний перегляд відгуку (контент, зображення, рейтинг).
- Інформація про автора та товар.
- Кнопки: "Затвердити", "Відхилити" (з можливістю додати коментар), "Видалити".
- При видаленні - автоматичне видалення зображень з бакету.

### 3.3 Навігація

Додати пункт "Відгуки" (іконка `MessageSquare`) в секцію "Контент" сайдбару адмінки.

---

## Фаза 4: Інтеграція

### 4.1 Сторінка товару ProductDetail

- Додати вкладку "Відгуки" в навігацію (поруч з Опис, Характеристики, Наявність).
- Показувати середній рейтинг та кількість поруч із назвою товару або ціною.
- Секція `ProductReviews` під секцією "Наявність".

### 4.2 Картка товару ProductCard

- Показувати середній рейтинг (зірки) та кількість відгуків під ціною.
- Хук для bulk-запиту рейтингів по масиву product_id.

### 4.3 Маршрути ThemeRouter

- `/admin/reviews` - список відгуків.
- `/admin/reviews/:reviewId` - деталі відгуку.

### 4.4 Видалення зображень

При видаленні відгуку (адміном або користувачем) - видаляти всі зображення з бакету `review-images/{productId}/`.

---

## Порядок реалізації

| Крок | Що робимо |
|---|---|
| 1 | SQL-міграція: таблиця `product_reviews`, бакет `review-images`, RLS |
| 2 | Компоненти `StarRating`, `ReviewCard`, `ReviewForm` |
| 3 | Хук `useProductReviews` |
| 4 | Компонент `ProductReviews` (секція на сторінці товару) |
| 5 | Інтеграція в `ProductDetail` (вкладка + середній рейтинг) |
| 6 | Адмін-сторінки модерації (`/admin/reviews`, `/admin/reviews/:reviewId`) |
| 7 | Оновлення сайдбару та ThemeRouter |
| 8 | Показ рейтингу на картках товарів |

---

## Технічні деталі

- **TipTap для відгуків**: спрощена конфігурація без Heading, Image, TextAlign - тільки базове форматування (bold, italic, underline, списки, посилання).
- **Зображення**: використовується існуючий `ImageUpload` з параметром `bucket="review-images"` та `folder={productId}`.
- **Санітизація HTML**: контент відгуків рендериться через `dangerouslySetInnerHTML`, але це прийнятно, бо TipTap генерує безпечний HTML, а модерація дає додатковий контроль.
- **Кеш рейтингів**: рейтинги кешуються через React Query з staleTime 60 секунд.
- **Bulk рейтинги для карток**: SQL-функція `get_product_ratings(product_ids uuid[])` для отримання середніх рейтингів масивом.
