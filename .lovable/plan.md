
# План: Система управління користувачами з підтримкою отримувачів

## ✅ Виконано (Етап 1-4)
Реалізація повноцінної системи управління користувачами в адмін-панелі з можливістю призначення ролей, автоматичної та ручної зміни категорій, управління профілями (включаючи аватари), збереження адрес доставки та контактних осіб (отримувачів). Особлива увага приділяється інтеграції отримувачів у процес оформлення замовлення.

---

## Частина 1: База даних

### Нові таблиці

**1. `user_category_history`** - історія зміни категорій
| Колонка | Тип | Опис |
|---------|-----|------|
| id | uuid | PK |
| user_id | uuid | FK до auth.users |
| from_category_id | uuid | Попередня категорія (nullable) |
| to_category_id | uuid | Нова категорія |
| reason | text | Причина зміни |
| rule_id | uuid | FK до правила (nullable) |
| changed_by | uuid | Хто змінив (null = автоматично) |
| created_at | timestamp | Час зміни |

**2. `category_rules`** - правила автоматичного переходу
| Колонка | Тип | Опис |
|---------|-----|------|
| id | uuid | PK |
| name | text | Назва правила |
| description | text | Опис |
| from_category_id | uuid | З якої категорії (null = всі) |
| to_category_id | uuid | До якої категорії |
| conditions | jsonb | Умови у структурованому форматі |
| is_active | boolean | Активне правило |
| priority | integer | Пріоритет виконання |
| created_at | timestamp | |

Приклад conditions:
```json
{
  "type": "all",
  "rules": [
    {"field": "total_purchases", "operator": ">=", "value": 50000},
    {"field": "registration_days", "operator": ">=", "value": 30}
  ]
}
```

Підтримувані поля умов:
- `total_purchases` - сума всіх покупок
- `registration_days` - кількість днів з реєстрації
- `utm_source` / `utm_campaign` - UTM мітки
- `email_domain` - домен email
- `auth_provider` - провайдер авторизації (google, email)

**3. `user_addresses`** - збережені адреси користувача
| Колонка | Тип | Опис |
|---------|-----|------|
| id | uuid | PK |
| user_id | uuid | FK до auth.users |
| name | text | Назва адреси ("Дім", "Робота") |
| city | text | Місто |
| address | text | Повна адреса |
| is_default | boolean | Адреса за замовчуванням |
| created_at | timestamp | |

**4. `user_recipients`** - контактні особи (отримувачі)
| Колонка | Тип | Опис |
|---------|-----|------|
| id | uuid | PK |
| user_id | uuid | FK до auth.users |
| first_name | text | Ім'я |
| last_name | text | Прізвище |
| phone | text | Телефон |
| email | text | Email (optional) |
| city | text | Місто |
| address | text | Адреса доставки |
| notes | text | Нотатки |
| is_default | boolean | Основний отримувач |
| created_at | timestamp | |

### Зміни в існуючих таблицях

**`profiles`** - додати поля:
| Колонка | Тип | Опис |
|---------|-----|------|
| avatar_url | text | URL аватара |
| default_shipping_method_id | uuid | Метод доставки за замовчуванням |
| default_pickup_point_id | uuid | Точка самовивозу за замовчуванням |
| auth_provider | text | google, email тощо |
| registration_utm | jsonb | UTM мітки при реєстрації |

**`orders`** - додати поля для отримувача:
| Колонка | Тип | Опис |
|---------|-----|------|
| has_different_recipient | boolean | Чи є інший отримувач |
| recipient_first_name | text | Ім'я отримувача |
| recipient_last_name | text | Прізвище отримувача |
| recipient_phone | text | Телефон отримувача |
| recipient_email | text | Email отримувача (optional) |
| saved_recipient_id | uuid | FK до user_recipients (якщо збережено) |

---

## Частина 2: Механізм отримувачів при оформленні замовлення

### Логіка роботи на Checkout

```text
+---------------------------------------------+
|          Контактні дані замовника           |
|  [Ім'я] [Прізвище] [Email] [Телефон]        |
+---------------------------------------------+

+---------------------------------------------+
|  [ ] Інший отримувач                        |
|                                             |
|  Якщо галочка активна:                      |
|  +---------------------------------------+  |
|  | Дані отримувача                       |  |
|  | [Ім'я] [Прізвище] [Телефон]           |  |
|  | [Email - optional]                    |  |
|  | [Місто] [Адреса]                      |  |
|  | [Нотатки]                             |  |
|  |                                       |  |
|  | [ ] Запам'ятати отримувача            |  |
|  +---------------------------------------+  |
|                                             |
|  Або вибрати збереженого (якщо є):          |
|  [Select: Мама (Київ), Друг (Львів)]        |
+---------------------------------------------+
```

### Сценарії роботи:

**Сценарій 1: Замовник = Отримувач**
- Галочка "Інший отримувач" не активна
- В замовлення записуються тільки дані замовника
- `has_different_recipient = false`
- Поля `recipient_*` залишаються NULL

**Сценарій 2: Інший отримувач (без збереження)**
- Галочка "Інший отримувач" активна
- Заповнюються поля отримувача
- Галочка "Запам'ятати" не активна
- `has_different_recipient = true`
- Поля `recipient_*` заповнюються
- `saved_recipient_id = NULL`
- Запис в `user_recipients` НЕ створюється

**Сценарій 3: Інший отримувач (зі збереженням)**
- Галочка "Інший отримувач" активна
- Заповнюються поля отримувача
- Галочка "Запам'ятати" активна
- При сабміті:
  1. Створюється запис в `user_recipients`
  2. `saved_recipient_id` = ID нового запису
  3. `has_different_recipient = true`
  4. Поля `recipient_*` також заповнюються (дублювання для історії)

**Сценарій 4: Вибір збереженого отримувача**
- Галочка "Інший отримувач" активна
- Користувач обирає зі списку збережених отримувачів
- Поля автозаповнюються даними обраного отримувача
- `saved_recipient_id` = ID обраного
- Поля `recipient_*` заповнюються (копія на момент замовлення)

### Відображення в замовленні (адмін + профіль)

Якщо `has_different_recipient = true`:
```text
Замовник: Іван Петренко, +380501234567
Отримувач: Марія Коваленко, +380671234567
           м. Київ, вул. Хрещатик, 1
           (Мама)
```

---

## Частина 3: Адмін-панель - Користувачі

### Сторінка `/admin/users` - Список користувачів
- Таблиця з колонками: Аватар, Ім'я, Email, Телефон, Категорія, Адмін, Сума покупок, Дата реєстрації
- Фільтри: за категорією, за роллю (адмін/користувач), за періодом реєстрації
- Пошук за email, ім'ям, телефоном
- Клікабельний рядок відкриває детальну картку

### Сторінка `/admin/users/:userId` - Картка користувача

**Секція 1: Основна інформація**
- Аватар (з можливістю завантаження нового адміном)
- ПІБ, Email, Телефон
- Дата реєстрації
- Провайдер авторизації (Google, Email тощо)
- UTM мітки при реєстрації

**Секція 2: Категорія та роль**
- Поточна категорія з кнопкою зміни (Select)
- Перемикач "Адміністратор" (простий toggle)
- Кнопка "Історія змін категорії" - відкриває модальне вікно

**Секція 3: Статистика**
- Загальна сума покупок
- Кількість замовлень
- Останнє замовлення

**Секція 4: Замовлення**
- Список останніх 10 замовлень з посиланнями

---

## Частина 4: Адмін-панель - Категорії користувачів

### Сторінка `/admin/user-categories` - Список категорій
- Таблиця: Назва, Код, Множник ціни, За замовчуванням, Кількість користувачів
- Кнопка "Додати категорію"
- Клікабельний рядок

### Сторінка `/admin/user-categories/:categoryId` - Редагування категорії
- Назва, Код, Опис
- Множник ціни (price_multiplier)
- Перемикач "За замовчуванням"

---

## Частина 5: Правила автоматичного переходу

### Нова сторінка `/admin/user-categories/rules` - Правила переходу
- Таблиця правил з пріоритетом та кнопками сортування
- Кнопка "Додати правило"
- Кнопка "Запустити перевірку всіх користувачів" (ручний запуск)

### Форма правила
- Назва правила
- З категорії → До категорії
- Умови (візуальний конструктор):
  - **Сума покупок** >= X грн
  - **Днів з реєстрації** >= X
  - **UTM мітка** містить "..."
  - **Домен email** = "..."
  - **Провайдер авторизації** = google/email/...
- Пріоритет виконання
- Активність

### Тригери перевірки
1. **При завершенні замовлення** - при зміні статусу на "Виконано" автоматично перевіряються правила для користувача
2. **Ручний запуск** - кнопка в адмінці для перевірки всіх користувачів

---

## Частина 6: Профіль користувача (публічна частина)

### Сторінка `/profile/settings` - розширити

**Секція: Аватар**
- Відображення поточного аватара (з Google або завантаженого)
- Кнопка "Завантажити фото"
- Ліміт 5MB, формати JPG/PNG/WEBP

**Секція: Адреси доставки**
- Список збережених адрес
- Кнопка "Додати адресу"
- Редагування/видалення адрес
- Позначка адреси за замовчуванням

**Секція: Отримувачі**
- Список контактних осіб
- Кнопка "Додати отримувача"
- Редагування/видалення отримувачів
- Форма: Ім'я, Прізвище, Телефон, Email, Місто, Адреса, Нотатки
- Позначка основного отримувача

**Секція: Доставка за замовчуванням**
- Вибір методу доставки за замовчуванням
- Вибір точки самовивозу за замовчуванням

---

## Частина 7: Зберігання аватарів

### Storage bucket: `user-avatars`
- Публічний bucket
- RLS політика: користувач може завантажувати лише в свою папку `{user_id}/`
- Ліміт: 5MB
- Формати: image/jpeg, image/png, image/webp

---

## Технічні деталі

### Database функції

**`check_category_rules(p_user_id uuid)`**
- Отримує всі активні правила за пріоритетом
- Для кожного правила перевіряє умови
- Якщо умови виконані - змінює категорію та записує історію
- Повертає boolean (чи була зміна)

**`get_user_stats(p_user_id uuid)`**
- Повертає: total_purchases, orders_count, registration_days

**`check_all_users_category_rules()`**
- Перебирає всіх користувачів
- Викликає check_category_rules для кожного
- Повертає кількість змінених

### Тригер на замовленнях
При зміні статусу замовлення - перевірити чи це статус "completed":
- Якщо так - викликати `check_category_rules` для user_id замовлення

### Підтримка розширень
Система правил через JSONB дозволяє плагінам додавати власні умови:
```json
{
  "type": "plugin",
  "plugin": "loyalty",
  "field": "loyalty_points",
  "operator": ">=",
  "value": 1000
}
```

---

## Нові файли

### Адмін-панель
```text
src/pages/admin/Users.tsx                    - Список користувачів
src/pages/admin/UserEdit.tsx                 - Картка користувача
src/pages/admin/UserCategories.tsx           - Список категорій
src/pages/admin/UserCategoryEdit.tsx         - Редагування категорії
src/pages/admin/UserCategoryRules.tsx        - Правила переходу
src/pages/admin/UserCategoryRuleEdit.tsx     - Редагування правила
src/components/admin/UserCategoryHistory.tsx - Модальне вікно історії
src/components/admin/CategoryRuleBuilder.tsx - Конструктор умов
```

### Checkout
```text
src/components/checkout/CheckoutRecipientForm.tsx - Форма іншого отримувача
```

### Профіль користувача
```text
src/components/profile/AvatarUpload.tsx      - Завантаження аватара
src/components/profile/AddressesList.tsx     - Список адрес
src/components/profile/AddressForm.tsx       - Форма адреси
src/components/profile/RecipientsList.tsx    - Список отримувачів
src/components/profile/RecipientForm.tsx     - Форма отримувача
src/components/profile/DefaultDelivery.tsx   - Налаштування доставки
src/pages/ProfileAddresses.tsx               - Сторінка адрес
src/pages/ProfileRecipients.tsx              - Сторінка отримувачів
```

---

## Маршрути (App.tsx)

```typescript
// Додати в admin routes:
<Route path="users" element={<Users />} />
<Route path="users/:userId" element={<UserEdit />} />
<Route path="user-categories" element={<UserCategories />} />
<Route path="user-categories/new" element={<UserCategoryEdit />} />
<Route path="user-categories/:categoryId" element={<UserCategoryEdit />} />
<Route path="user-categories/rules" element={<UserCategoryRules />} />
<Route path="user-categories/rules/new" element={<UserCategoryRuleEdit />} />
<Route path="user-categories/rules/:ruleId" element={<UserCategoryRuleEdit />} />

// Додати в profile routes:
<Route path="addresses" element={<ProfileAddresses />} />
<Route path="recipients" element={<ProfileRecipients />} />
```

---

## Порядок реалізації

### Етап 1: База даних
1. Міграція - нові таблиці (user_category_history, category_rules, user_addresses, user_recipients)
2. Міграція - зміни в profiles (avatar_url, default_shipping_method_id, auth_provider, registration_utm)
3. Міграція - зміни в orders (has_different_recipient, recipient_*, saved_recipient_id)
4. Storage bucket для аватарів

### Етап 2: Адмін-панель користувачів
5. Список користувачів
6. Картка користувача
7. Toggle адміністратора

### Етап 3: Категорії та правила
8. CRUD категорій
9. Правила переходу з конструктором умов
10. Історія змін категорій
11. Database функції для перевірки правил
12. Тригер на замовленнях

### Етап 4: Профіль користувача
13. Завантаження аватара
14. Адреси доставки
15. Отримувачі
16. Налаштування доставки за замовчуванням

### Етап 5: Інтеграція з Checkout
17. Форма "Інший отримувач"
18. Вибір збережених отримувачів
19. Збереження нового отримувача
20. Оновлення відображення замовлення (адмін + профіль)

### Етап 6: Автозаповнення
21. Інтеграція збережених адрес/отримувачів/методів доставки в Checkout

