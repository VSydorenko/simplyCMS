

## Система замовлень - Комплексний план реалізації

### Поточний стан

**Вже реалізовано:**
- Таблиці `orders`, `order_items`, `order_statuses` в базі даних
- 6 статусів замовлень (Новий, Підтверджено, В обробці, Відправлено, Доставлено, Скасовано)
- Edge-функція `get-guest-order` для гостьових замовлень з токеном доступу
- Базова сторінка `/admin/orders` з таблицею замовлень
- Аутентифікація користувачів (email/пароль + Google OAuth)
- Профілі користувачів з категоріями ціноутворення

**Потрібно реалізувати:**
- Кошик (cart) - зберігання та управління
- Сторінка оформлення замовлення (Checkout)
- Детальна сторінка замовлення в адмінці з редагуванням
- Особистий кабінет з історією замовлень
- Управління статусами замовлень

---

### Архітектура рішення

```text
┌─────────────────────────────────────────────────────────────┐
│                     FRONTEND                                 │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌──────────┐  ┌─────────┐  ┌───────────────┐  │
│  │ Кошик   │→ │ Checkout │→ │ Success │  │ Особистий     │  │
│  │(Cart)   │  │  Page    │  │  Page   │  │ кабінет       │  │
│  └─────────┘  └──────────┘  └─────────┘  └───────────────┘  │
│       ↑                          ↓               ↓          │
│  ┌─────────┐              ┌───────────┐  ┌───────────────┐  │
│  │Product  │              │ Order API │  │ Orders List   │  │
│  │Detail   │              │           │  │ + Detail      │  │
│  └─────────┘              └───────────┘  └───────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                      ADMIN PANEL                             │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌───────────────┐  ┌──────────────────┐  │
│  │ Orders List  │→ │ Order Detail  │  │ Order Statuses   │  │
│  │ (improved)   │  │ + Edit Items  │  │ Management       │  │
│  └──────────────┘  └───────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

### Частина 1: Кошик (Cart)

**Підхід:** LocalStorage + React Context для швидкодії та роботи без авторизації

**Нові файли:**

| Файл | Призначення |
|------|-------------|
| `src/hooks/useCart.tsx` | Context + hook для управління кошиком |
| `src/components/cart/CartDrawer.tsx` | Бокова панель кошика (Sheet) |
| `src/components/cart/CartItem.tsx` | Компонент одного товару в кошику |
| `src/pages/Cart.tsx` | Повноекранна сторінка кошика |

**Структура даних кошика:**
```typescript
interface CartItem {
  productId: string;
  modificationId: string | null;
  name: string;
  modificationName?: string;
  price: number;
  quantity: number;
  image?: string;
  sku?: string;
}
```

**Функціонал:**
- Додавання товару з ProductDetail (з обраною модифікацією)
- Зміна кількості (+/-)
- Видалення товару
- Підрахунок загальної суми
- Збереження в localStorage
- Badge з кількістю товарів на іконці кошика

---

### Частина 2: Оформлення замовлення (Checkout)

**Нові файли:**

| Файл | Призначення |
|------|-------------|
| `src/pages/Checkout.tsx` | Головна сторінка оформлення |
| `src/components/checkout/CheckoutForm.tsx` | Форма контактних даних |
| `src/components/checkout/DeliveryForm.tsx` | Вибір способу доставки |
| `src/components/checkout/PaymentForm.tsx` | Вибір способу оплати |
| `src/components/checkout/OrderSummary.tsx` | Підсумок замовлення |
| `src/pages/OrderSuccess.tsx` | Сторінка успішного замовлення |

**Потік оформлення:**
1. Перевірка наявності товарів у кошику
2. Заповнення контактних даних (автозаповнення для залогінених)
3. Вибір способу доставки (Самовивіз / Нова Пошта / Кур'єр)
4. Вибір способу оплати (Оплата при отриманні / Онлайн)
5. Підтвердження замовлення

**Зміни в базі даних:**
```sql
-- Функція для генерації номера замовлення
CREATE OR REPLACE FUNCTION generate_order_number()
RETURNS TRIGGER AS $$
BEGIN
  NEW.order_number := 'ORD-' || TO_CHAR(NOW(), 'YYMMDD') || '-' || 
    LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_order_number
  BEFORE INSERT ON orders
  FOR EACH ROW
  WHEN (NEW.order_number IS NULL OR NEW.order_number = '')
  EXECUTE FUNCTION generate_order_number();
```

---

### Частина 3: Особистий кабінет користувача

**Нові файли:**

| Файл | Призначення |
|------|-------------|
| `src/pages/Profile.tsx` | Головна сторінка кабінету |
| `src/pages/ProfileOrders.tsx` | Список замовлень користувача |
| `src/pages/ProfileOrderDetail.tsx` | Деталі конкретного замовлення |
| `src/pages/ProfileSettings.tsx` | Налаштування профілю |
| `src/components/profile/ProfileLayout.tsx` | Layout з навігацією |

**Функціонал:**
- Перегляд та редагування профілю (ім'я, телефон)
- Список замовлень з фільтрацією за статусом
- Детальний перегляд замовлення
- Можливість скасування (тільки для статусу "Новий")

---

### Частина 4: Адмін-панель замовлень (розширення)

**Оновлені/нові файли:**

| Файл | Зміни |
|------|-------|
| `src/pages/admin/Orders.tsx` | Фільтри, пошук, пагінація |
| `src/pages/admin/OrderDetail.tsx` | Детальна сторінка замовлення |
| `src/components/admin/OrderItems.tsx` | Таблиця товарів замовлення |
| `src/components/admin/OrderItemEditor.tsx` | Редагування/додавання товарів |
| `src/components/admin/OrderStatusChanger.tsx` | Зміна статусу |
| `src/pages/admin/OrderStatuses.tsx` | Управління статусами |

**Функціонал OrderDetail:**
- Повна інформація про клієнта
- Таблиця товарів з можливістю:
  - Зміни кількості
  - Видалення позиції
  - Додавання нового товару/модифікації
  - Автоматичний перерахунок суми
- Історія змін статусу
- Зміна статусу з коментарем
- Додавання нотаток

**Функціонал OrderStatuses:**
- Таблиця статусів з drag-and-drop сортуванням
- Редагування назви, коду, кольору
- Встановлення статусу за замовчуванням

---

### Частина 5: Маршрутизація

**Оновлення App.tsx:**
```text
/cart                           → Сторінка кошика
/checkout                       → Оформлення замовлення  
/order-success/:orderId         → Успішне замовлення
/order/:orderId/:token          → Перегляд гостьового замовлення

/profile                        → Особистий кабінет (захищено)
/profile/orders                 → Мої замовлення
/profile/orders/:orderId        → Деталі замовлення
/profile/settings               → Налаштування

/admin/orders                   → Список замовлень (покращено)
/admin/orders/:orderId          → Редагування замовлення
/admin/order-statuses           → Управління статусами
```

---

### Послідовність реалізації

**Етап 1: Кошик**
1. Створити `useCart` context та hook
2. Інтегрувати з ProductDetail (кнопка "Додати в кошик")
3. Створити CartDrawer
4. Оновити header з badge

**Етап 2: Checkout**
1. Створити сторінку Checkout з формою
2. Додати тригер для генерації order_number
3. Інтегрувати створення замовлення
4. Створити OrderSuccess сторінку
5. Очищення кошика після замовлення

**Етап 3: Особистий кабінет**
1. Створити ProfileLayout
2. Реалізувати ProfileOrders з фільтрацією
3. Реалізувати ProfileOrderDetail
4. Додати ProfileSettings

**Етап 4: Адмін-панель**
1. Покращити Orders.tsx (пошук, фільтри)
2. Створити OrderDetail з редагуванням
3. Реалізувати OrderItemEditor
4. Створити OrderStatuses управління

---

### Технічні деталі

**Валідація форми (Checkout):**
- Ім'я/Прізвище: 2-100 символів
- Email: валідний формат
- Телефон: українский формат
- Адреса: обов'язкова при кур'єрській доставці

**RLS політики (вже налаштовані):**
- Users INSERT: `(auth.uid() = user_id) OR (user_id IS NULL)`
- Users SELECT: `(auth.uid() = user_id) AND (auth.uid() IS NOT NULL)`
- Admins: повний доступ через `is_admin()`

**Edge-функція (вже є):**
- `get-guest-order` - отримання гостьового замовлення за токеном

