
# План спрощення системи доставки

## Проблема

Поточна система занадто складна для локального ринку. Є 4 окремі сутності (локації, зони, прив'язки, тарифи), які плутають і потребують багато зусиль для налаштування.

## Пропозиція: Об'єднати Локації та Зони

### Концепція спрощення

**БУЛО (складно):**
```
Локації → Зони → Тарифи
   ↓         ↓
  cities   zone_locations
```

**СТАНЕ (просто):**
```
Зони доставки → Тарифи (вбудовані в зону)
     ↓
  cities (текстовий список)
```

### Що зміниться

1. **Видалити таблицю `locations`** - замість довідника, адміністратор просто вписує назви міст у текстове поле або список

2. **Видалити таблицю `shipping_zone_locations`** - проміжна таблиця більше не потрібна

3. **Розширити `shipping_zones`** новими полями:
   - `cities` (text[]) - масив назв міст, що входять в зону
   - `regions` (text[]) - масив назв областей (опціонально)

4. **Спростити UI**:
   - Одна сторінка "Зони доставки" замість двох
   - В редакторі зони - просто текстове поле для списку міст
   - Тарифи залишаються прив'язаними до зони

### Новий флоу для адміністратора

1. Створити зону "Київ і передмістя"
2. Вписати міста: "Київ, Бровари, Вишневе, Ірпінь"
3. Додати тариф: "Кур'єр - 100 грн"
4. Готово!

### Визначення зони на checkout

Замість складного алгоритму - простий пошук:
```typescript
// Знайти зону за містом клієнта
const zone = zones.find(z => 
  z.cities?.some(city => 
    normalize(city) === normalize(customerCity)
  )
);
```

## Зміни в базі даних

### Видалення
- Таблиця `locations`
- Таблиця `shipping_zone_locations`
- Enum `location_type`
- Enum `zone_location_type`

### Модифікація `shipping_zones`
```sql
ALTER TABLE shipping_zones
ADD COLUMN cities text[] DEFAULT '{}',
ADD COLUMN regions text[] DEFAULT '{}';
```

## Зміни в UI

### Видалити
- Сторінка `/admin/shipping/locations`
- Пункт меню "Локації"

### Спростити `ShippingZoneEdit.tsx`
- Замість селектора локацій - textarea для списку міст
- Можливість вводити через кому або по рядках

## Зміни в логіці

### Спростити `findZone.ts`
- Видалити складний алгоритм порівняння
- Простий пошук по масиву cities/regions

### Оновити типи в `types.ts`
- Видалити `Location`, `ShippingZoneLocation`
- Додати `cities` та `regions` до `ShippingZone`

## Приклади використання

### Приклад 1: Доставка по Києву
- Зона: "Київ"
- Міста: ["Київ"]
- Тариф кур'єра: 80 грн

### Приклад 2: Київська область
- Зона: "Київська область"
- Міста: ["Бровари", "Вишневе", "Ірпінь", "Буча", "Обухів", ...]
- Тариф кур'єра: 150 грн

### Приклад 3: Вся Україна (за замовчуванням)
- Зона: "Україна"
- is_default: true (застосовується, якщо місто не знайдено в інших зонах)
- Тариф: За тарифами перевізника

## Послідовність реалізації

1. Міграція БД: додати нові поля, видалити старі таблиці
2. Оновити типи TypeScript
3. Спростити `findZone.ts`
4. Оновити `ShippingZoneEdit.tsx` - додати поле для міст
5. Видалити сторінку Locations та пункт меню
6. Оновити маршрути в `App.tsx`
7. Тестування

## Технічні деталі

### Нова структура ShippingZone
```typescript
interface ShippingZone {
  id: string;
  name: string;
  description: string | null;
  cities: string[];     // Нове поле
  regions: string[];    // Нове поле
  is_active: boolean;
  is_default: boolean;
  sort_order: number;
  created_at: string;
}
```

### Спрощений findZone
```typescript
function findShippingZone(customerCity: string): ShippingZone | null {
  const normalized = customerCity.toLowerCase().trim();
  
  // Шукаємо зону за містом
  for (const zone of zones) {
    if (zone.cities?.some(c => c.toLowerCase().trim() === normalized)) {
      return zone;
    }
  }
  
  // Повертаємо зону за замовчуванням
  return zones.find(z => z.is_default) || null;
}
```

## Результат

- 2 таблиці замість 4
- Одна сторінка адміністрування замість двох
- Простий і зрозумілий інтерфейс
- Легше підтримувати і розширювати плагінами
