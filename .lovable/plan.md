
# План вдосконалення системи оформлення замовлення

## Огляд
Реалізація розширеної системи checkout з підтримкою гостьового оформлення, вбудованої авторизації, покращеного вибору отримувачів через картки, управління адресами доставки та повноцінного управління довідниками в кабінеті користувача.

---

## Етап 1: Гостьове оформлення без реєстрації

### Що буде зроблено
- Додавання режиму "Оформити як гість" для неавторизованих користувачів
- Зміна валідації: email АБО телефон обов'язкові (не обидва одночасно)
- Спрощена форма контактних даних без вимоги пароля

### Компоненти
- `CheckoutGuestModeToggle.tsx` - перемикач режиму (гість/авторизація/реєстрація)
- Оновлення валідації в `Checkout.tsx`:
```text
email: z.string().optional()
phone: z.string().optional()
+ refine: хоча б одне з полів (email або phone) заповнено
```

---

## Етап 2: Вбудована авторизація на checkout

### Що буде зроблено
- Компактний блок авторизації прямо на сторінці checkout
- Tabs: "Оформити як гість" / "Увійти" / "Зареєструватись"
- Підтримка Google OAuth
- Після успішної авторизації - автозаповнення полів з профілю, залишаємось на checkout

### Компоненти
- `CheckoutAuthBlock.tsx` - вбудовані форми входу/реєстрації
  - Компактний дизайн без перенаправлення на /auth
  - Кнопка "Увійти через Google"
  - При успішній авторизації оновлюються поля форми checkout

---

## Етап 3: Картки отримувачів на checkout

### Що буде зроблено
- При активації "Інший отримувач" показуються до 3 карток збережених отримувачів
- Кожна картка містить: ім'я, телефон (скорочено), місто
- Візуальне виділення обраної картки
- Кнопка "Показати всіх" якщо отримувачів > 3
- Popup з повним списком, пошуком та сортуванням

### Компоненти
- `RecipientCard.tsx` - компактна картка отримувача
```text
+-------------------------+
| Іван Петренко           |
| +380...567              |
| м. Київ                 |
+-------------------------+
```
- `RecipientSelectorPopup.tsx` - повний список з фільтрами
  - Пошук за ім'ям, телефоном, містом
  - Сортування: за замовчуванням, за ім'ям, за датою
- Оновлення `CheckoutRecipientForm.tsx` - інтеграція карток

### Логіка вибору
1. Клік на картку - вибір отримувача, заповнення полів
2. Повторний клік - зняття вибору
3. Можна змінити вибір на іншу картку в будь-який момент

---

## Етап 4: Редагування отримувачів з підтвердженням

### Що буде зроблено
- Поля отримувача редаговані після вибору з довідника
- Відстеження змін: порівняння поточних даних з оригіналом
- Кнопка "Зберегти зміни" з'являється при модифікації
- Діалог підтвердження з варіантами дій

### Компоненти
- `RecipientSaveDialog.tsx` - діалог вибору дії:
```text
+---------------------------------------+
| Зберегти дані отримувача?             |
|                                       |
| [Оновити "Іван Петренко"]             |
| [Створити нового отримувача]          |
| [Скасувати]                           |
+---------------------------------------+
```

### Логіка збереження
1. **Якщо обрано існуючого + внесено зміни:**
   - Показати діалог з опціями: оновити / створити нового / скасувати
2. **Якщо "Створити нового":**
   - Зняти зв'язок з оригіналом
   - Зберегти як нового отримувача
3. **Якщо введено всі дані з нуля (без вибору):**
   - Запропонувати "Зберегти отримувача" (чекбокс)

---

## Етап 5: Картки адрес доставки

### Що буде зроблено
- Аналогічна система карток для збережених адрес
- 3 картки + кнопка "Показати всі" для popup
- Вибір адреси заповнює поля міста та адреси доставки
- Редагування з підтвердженням (оновити/створити нову)

### Компоненти
- `AddressCard.tsx` - картка адреси
```text
+-------------------------+
| Дім (за замовч.)        |
| м. Київ                 |
| вул. Хрещатик, 1        |
+-------------------------+
```
- `AddressSelectorPopup.tsx` - popup для вибору
- `AddressSaveDialog.tsx` - діалог збереження
- Інтеграція в `CheckoutDeliveryForm.tsx`

---

## Етап 6: Збереження даних в замовлення (копіювання текстом)

### Принцип
Всі дані отримувача та адреси копіюються в замовлення як текст. Додатково зберігається посилання на оригінальний запис для аналітики. При видаленні запису з довідника - посилання очищується, але текстові дані залишаються.

### Зміни в БД
Додати колонку до таблиці `orders`:
```text
saved_address_id uuid REFERENCES user_addresses(id) ON DELETE SET NULL
```

Також додати тригери для очищення посилань при видаленні:
- `ON DELETE SET NULL` на `saved_recipient_id`
- `ON DELETE SET NULL` на `saved_address_id`

### Логіка збереження при оформленні
```text
1. Копіювати дані отримувача в recipient_* колонки
2. Копіювати адресу в delivery_city, delivery_address
3. Зберігати saved_recipient_id та saved_address_id як reference
4. При видаленні з довідника - посилання автоматично стає NULL
5. Текстові дані в замовленні залишаються незмінними
```

---

## Етап 7: Повноцінне управління довідниками в кабінеті користувача

### Структура кабінету користувача

#### Головна сторінка профілю (`/profile`)
Залишається без змін - огляд профілю та останні замовлення.

#### Налаштування (`/profile/settings`)
Розширюється додатковими секціями:

```text
1. Фото профілю (існує)
2. Особисті дані (існує)
3. Зміна пароля (існує)
4. Адреси доставки (існує, потребує оновлення)
5. Контактні особи (існує, потребує оновлення)
```

### Оновлення компонента AddressesList

#### Поточна функціональність
- Список адрес з редагуванням та видаленням
- Додавання нової адреси через діалог

#### Що додається
1. **Попередження при видаленні:**
```text
+-----------------------------------------------+
| Видалити адресу "Дім"?                        |
|                                               |
| Ця адреса використовується в 3 замовленнях.   |
| Дані адреси в замовленнях збережуться.        |
|                                               |
| [Скасувати]  [Видалити]                       |
+-----------------------------------------------+
```

2. **Відображення кількості використань:**
   - Показувати "Використано в N замовленнях" біля кожної адреси

3. **Фонове очищення посилань:**
   - При видаленні - `ON DELETE SET NULL` на FK автоматично очистить `saved_address_id` в замовленнях
   - Текстові дані (`delivery_city`, `delivery_address`) залишаються

### Оновлення компонента RecipientsList

#### Поточна функціональність
- Список отримувачів з редагуванням та видаленням
- Додавання нового отримувача через діалог

#### Що додається
1. **Попередження при видаленні:**
```text
+-----------------------------------------------+
| Видалити отримувача "Іван Петренко"?          |
|                                               |
| Цей контакт використовується в 5 замовленнях. |
| Дані отримувача в замовленнях збережуться.    |
|                                               |
| [Скасувати]  [Видалити]                       |
+-----------------------------------------------+
```

2. **Відображення кількості використань:**
   - Показувати "Використано в N замовленнях" біля кожного отримувача

3. **Покращене відображення:**
   - Картки замість простого списку
   - Більше інформації (email, адреса)

### Технічна реалізація очищення посилань

#### Варіант 1: ON DELETE SET NULL (обраний)
```text
ALTER TABLE orders
ADD CONSTRAINT fk_saved_address
FOREIGN KEY (saved_address_id) 
REFERENCES user_addresses(id) 
ON DELETE SET NULL;
```

При видаленні адреси з довідника:
- `saved_address_id` в замовленнях автоматично стає `NULL`
- `delivery_city`, `delivery_address` залишаються незмінними
- Історія замовлень повністю збережена

#### Варіант 2: Фонова функція (альтернатива)
Якщо потрібна додаткова логіка (логування, повідомлення):
```text
CREATE OR REPLACE FUNCTION clear_address_references()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE orders 
  SET saved_address_id = NULL 
  WHERE saved_address_id = OLD.id;
  RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER before_address_delete
BEFORE DELETE ON user_addresses
FOR EACH ROW EXECUTE FUNCTION clear_address_references();
```

### Запит кількості використань для UI

Для відображення "Використано в N замовленнях":

**Для адрес:**
```text
SELECT 
  a.*,
  COUNT(o.id) as usage_count
FROM user_addresses a
LEFT JOIN orders o ON o.saved_address_id = a.id
WHERE a.user_id = :user_id
GROUP BY a.id
ORDER BY a.is_default DESC, a.created_at DESC
```

**Для отримувачів:**
```text
SELECT 
  r.*,
  COUNT(o.id) as usage_count
FROM user_recipients r
LEFT JOIN orders o ON o.saved_recipient_id = r.id
WHERE r.user_id = :user_id
GROUP BY r.id
ORDER BY r.is_default DESC, r.created_at DESC
```

---

## Архітектура компонентів

### Нові компоненти
```text
src/components/checkout/
├── CheckoutAuthBlock.tsx        # Вбудована авторизація (вхід/реєстрація/гість)
├── CheckoutGuestModeToggle.tsx  # Перемикач режиму
├── RecipientCard.tsx            # Картка отримувача
├── RecipientSelectorPopup.tsx   # Popup вибору отримувача
├── RecipientSaveDialog.tsx      # Діалог збереження змін
├── AddressCard.tsx              # Картка адреси
├── AddressSelectorPopup.tsx     # Popup вибору адреси
└── AddressSaveDialog.tsx        # Діалог збереження адреси

src/components/profile/
├── AddressesList.tsx            # Оновлений - з попередженням та лічильником
├── RecipientsList.tsx           # Оновлений - з попередженням та лічильником
└── DeleteConfirmDialog.tsx      # Діалог підтвердження видалення
```

### Зміни в БД
```text
1. ALTER TABLE orders ADD COLUMN saved_address_id uuid 
   REFERENCES user_addresses(id) ON DELETE SET NULL;

2. ALTER TABLE orders 
   DROP CONSTRAINT IF EXISTS orders_saved_recipient_id_fkey,
   ADD CONSTRAINT orders_saved_recipient_id_fkey 
   FOREIGN KEY (saved_recipient_id) 
   REFERENCES user_recipients(id) ON DELETE SET NULL;
```

---

## Порядок імплементації

1. **Етап 1-2** - Гостьовий режим та вбудована авторизація
2. **Етап 3-4** - Картки отримувачів з редагуванням та підтвердженням
3. **Етап 5** - Картки адрес доставки
4. **Етап 6** - Міграція БД (saved_address_id, ON DELETE SET NULL)
5. **Етап 7** - Оновлення кабінету користувача (попередження, лічильники)

---

## Очікувані результати

- Швидке оформлення для гостей без реєстрації
- Зручна авторизація прямо на сторінці checkout
- Інтуїтивний вибір отримувачів та адрес через картки
- Безпечне редагування з чітким підтвердженням дій
- Повна історія замовлень незалежно від змін у довідниках
- Прозоре управління довідниками з інформацією про використання
